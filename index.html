<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Alkhulafau SHS Student Management</title>
  
  <!-- Manifest for PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#722f37">
  
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* CSS Variables for theming */
    :root {
      --wine: #722f37;
      --wine-light: #8a3a44;
      --wine-dark: #5a262d;
      --white: #ffffff;
      --light-bg: #f8f9fa;
      --light-card: #ffffff;
      --light-text: #333333;
      --light-border: #e0e0e0;
      --dark-bg: #1a1a1a;
      --dark-card: #2d2d2d;
      --dark-text: #f0f0f0;
      --dark-border: #444444;
      --success: #28a745;
      --danger: #dc3545;
      --warning: #ffc107;
      --info: #17a2b8;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --radius: 8px;
    }

    /* Base styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--light-bg);
      color: var(--light-text);
      line-height: 1.6;
      transition: background-color 0.3s, color 0.3s;
    }

    body.dark {
      background-color: var(--dark-bg);
      color: var(--dark-text);
    }

    .container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    /* Header */
    header {
      background-color: var(--wine);
      color: var(--white);
      padding: 1rem 0;
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo i {
      font-size: 1.8rem;
    }

    .header-actions {
      display: flex;
      gap: 10px;
    }

    /* Buttons */
    button {
      cursor: pointer;
      border: none;
      border-radius: var(--radius);
      padding: 0.6rem 1.2rem;
      font-weight: 500;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background-color: var(--wine);
      color: var(--white);
    }

    .btn-primary:hover {
      background-color: var(--wine-light);
    }

    .btn-secondary {
      background-color: var(--light-border);
      color: var(--light-text);
    }

    body.dark .btn-secondary {
      background-color: var(--dark-border);
      color: var(--dark-text);
    }

    .btn-secondary:hover {
      background-color: #d0d0d0;
    }

    body.dark .btn-secondary:hover {
      background-color: #555555;
    }

    .btn-success {
      background-color: var(--success);
      color: var(--white);
    }

    .btn-danger {
      background-color: var(--danger);
      color: var(--white);
    }

    .btn-warning {
      background-color: var(--warning);
      color: var(--dark-text);
    }

    .btn-info {
      background-color: var(--info);
      color: var(--white);
    }

    .theme-toggle {
      background: transparent;
      color: var(--white);
      font-size: 1.2rem;
      padding: 0.5rem;
    }

    /* Navigation */
    nav {
      background-color: var(--white);
      box-shadow: var(--shadow);
      position: sticky;
      top: 70px;
      z-index: 99;
    }

    body.dark nav {
      background-color: var(--dark-card);
    }

    .nav-container {
      display: flex;
      justify-content: center;
    }

    .nav-links {
      display: flex;
      list-style: none;
      gap: 0;
    }

    .nav-link {
      padding: 1rem 1.5rem;
      text-decoration: none;
      color: var(--light-text);
      font-weight: 500;
      transition: all 0.3s;
      border-bottom: 3px solid transparent;
    }

    body.dark .nav-link {
      color: var(--dark-text);
    }

    .nav-link:hover, .nav-link.active {
      background-color: rgba(114, 47, 55, 0.1);
      border-bottom-color: var(--wine);
    }

    body.dark .nav-link:hover, body.dark .nav-link.active {
      background-color: rgba(114, 47, 55, 0.3);
    }

    /* Main content */
    main {
      padding: 2rem 0;
      min-height: calc(100vh - 200px);
    }

    .page {
      display: none;
    }

    .page.active {
      display: block;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Cards */
    .card {
      background-color: var(--light-card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    body.dark .card {
      background-color: var(--dark-card);
    }

    .card h2 {
      margin-bottom: 1rem;
      color: var(--wine);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    body.dark .card h2 {
      color: var(--wine-light);
    }

    /* Dashboard */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: linear-gradient(135deg, var(--wine), var(--wine-light));
      color: var(--white);
      padding: 1.5rem;
      border-radius: var(--radius);
      text-align: center;
      box-shadow: var(--shadow);
    }

    .stat-card i {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      margin: 0.5rem 0;
    }

    .stat-label {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .chart-container {
      margin: 2rem 0;
      background-color: var(--light-card);
      padding: 1.5rem;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    body.dark .chart-container {
      background-color: var(--dark-card);
    }

    .actions {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      margin-top: 1.5rem;
    }

    /* Upload page */
    .file-upload {
      border: 2px dashed var(--light-border);
      border-radius: var(--radius);
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      margin: 1.5rem 0;
    }

    body.dark .file-upload {
      border-color: var(--dark-border);
    }

    .file-upload:hover {
      border-color: var(--wine);
      background-color: rgba(114, 47, 55, 0.05);
    }

    body.dark .file-upload:hover {
      background-color: rgba(114, 47, 55, 0.1);
    }

    .file-upload i {
      font-size: 3rem;
      color: var(--wine);
      margin-bottom: 1rem;
    }

    .file-upload p {
      margin-bottom: 1rem;
    }

    .upload-preview {
      margin-top: 2rem;
    }

    /* Tables */
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
    }

    th, td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid var(--light-border);
    }

    body.dark th, body.dark td {
      border-bottom: 1px solid var(--dark-border);
    }

    th {
      background-color: rgba(114, 47, 55, 0.1);
      font-weight: 600;
    }

    body.dark th {
      background-color: rgba(114, 47, 55, 0.2);
    }

    tr:hover {
      background-color: rgba(114, 47, 55, 0.05);
    }

    body.dark tr:hover {
      background-color: rgba(114, 47, 55, 0.1);
    }

    /* Search and filter */
    .search-container {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }

    .search-input {
      flex: 1;
      min-width: 250px;
      padding: 0.75rem;
      border: 1px solid var(--light-border);
      border-radius: var(--radius);
      font-size: 1rem;
    }

    body.dark .search-input {
      background-color: var(--dark-card);
      border-color: var(--dark-border);
      color: var(--dark-text);
    }

    .filter-container {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }

    .filter-select {
      padding: 0.5rem;
      border: 1px solid var(--light-border);
      border-radius: var(--radius);
      background-color: var(--white);
    }

    body.dark .filter-select {
      background-color: var(--dark-card);
      border-color: var(--dark-border);
      color: var(--dark-text);
    }

    /* Student details */
    .student-details {
      display: none;
    }

    .student-details.active {
      display: block;
    }

    .student-info {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
      margin: 1.5rem 0;
    }

    .info-item {
      padding: 1rem;
      background-color: rgba(114, 47, 55, 0.05);
      border-radius: var(--radius);
    }

    body.dark .info-item {
      background-color: rgba(114, 47, 55, 0.1);
    }

    .info-label {
      font-weight: 600;
      color: var(--wine);
    }

    body.dark .info-label {
      color: var(--wine-light);
    }

    /* Toast notification */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--wine);
      color: var(--white);
      padding: 1rem 1.5rem;
      border-radius: var(--radius);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 1000;
      transform: translateY(100px);
      opacity: 0;
      transition: transform 0.3s, opacity 0.3s;
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    .toast.success {
      background-color: var(--success);
    }

    .toast.error {
      background-color: var(--danger);
    }

    .toast.warning {
      background-color: var(--warning);
      color: var(--dark-text);
    }

    .toast.info {
      background-color: var(--info);
    }

    /* Modal */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal.active {
      display: flex;
      animation: fadeIn 0.3s ease;
    }

    .modal-content {
      background: var(--light-card);
      padding: 2rem;
      border-radius: var(--radius);
      max-width: 500px;
      width: 90%;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }

    body.dark .modal-content {
      background: var(--dark-card);
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
      margin-top: 1.5rem;
    }

    /* Footer */
    footer {
      background-color: var(--wine-dark);
      color: var(--white);
      text-align: center;
      padding: 1.5rem 0;
      margin-top: 2rem;
    }

    /* Responsive design */
    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        gap: 1rem;
      }
      
      .nav-links {
        flex-direction: column;
        width: 100%;
      }
      
      .nav-link {
        text-align: center;
        border-bottom: 1px solid var(--light-border);
        border-left: 3px solid transparent;
      }
      
      body.dark .nav-link {
        border-bottom: 1px solid var(--dark-border);
      }
      
      .nav-link.active, .nav-link:hover {
        border-left-color: var(--wine);
        border-bottom-color: var(--light-border);
      }
      
      .stats-container {
        grid-template-columns: 1fr;
      }
      
      .student-info {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <header>
    <div class="container header-content">
      <div class="logo">
        <i class="fas fa-graduation-cap"></i>
        <h1>Alkhulafau SHS Student Management</h1>
      </div>
      <div class="header-actions">
        <button id="installBtn" style="display:none;" class="btn-primary">
          <i class="fas fa-download"></i> Install App
        </button>
        <button id="themeToggle" class="theme-toggle">
          <i class="fas fa-moon"></i>
        </button>
      </div>
    </div>
  </header>

  <nav>
    <div class="container nav-container">
      <ul class="nav-links">
        <li><a href="#" class="nav-link active" data-page="dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
        <li><a href="#" class="nav-link" data-page="upload"><i class="fas fa-upload"></i> Upload</a></li>
        <li><a href="#" class="nav-link" data-page="search"><i class="fas fa-search"></i> Search</a></li>
      </ul>
    </div>
  </nav>

  <main class="container">
    <!-- Dashboard Page -->
    <div class="page active" id="dashboard">
      <div class="card">
        <h2><i class="fas fa-tachometer-alt"></i> Dashboard Overview</h2>
        
        <div class="stats-container">
          <div class="stat-card">
            <i class="fas fa-users"></i>
            <div class="stat-value" id="total-students">0</div>
            <div class="stat-label">Total Students</div>
          </div>
          <div class="stat-card">
            <i class="fas fa-calendar-alt"></i>
            <div class="stat-value" id="current-year">2025</div>
            <div class="stat-label">Current Year</div>
          </div>
          <div class="stat-card">
            <i class="fas fa-clock"></i>
            <div class="stat-value" id="last-updated">Never</div>
            <div class="stat-label">Last Updated</div>
          </div>
        </div>
        
        <div class="chart-container">
          <h3>Student Distribution</h3>
          <canvas id="chartStudents" height="150"></canvas>
        </div>
        
        <div class="actions">
          <button id="backupBtn" class="btn-primary">
            <i class="fas fa-download"></i> Backup Data
          </button>
          <button id="restoreBtn" class="btn-secondary">
            <i class="fas fa-upload"></i> Restore Backup
          </button>
          <button id="refreshBtn" class="btn-info">
            <i class="fas fa-sync-alt"></i> Refresh Data
          </button>
        </div>
      </div>
    </div>

    <!-- Upload Page -->
    <div id="upload" class="page">
      <div class="card">
        <h2><i class="fas fa-upload"></i> Upload Student Placement List</h2>
        <p>Upload an Excel file containing student placement information. All columns will be preserved and displayed as-is.</p>
        
        <div class="file-upload" id="file-upload-area">
          <i class="fas fa-file-excel"></i>
          <p>Drag & drop an Excel file here or click to browse</p>
          <p class="small">Supported formats: .xlsx, .xls, .csv</p>
          <input type="file" id="excel-file" accept=".xlsx, .xls, .csv" style="display: none;">
        </div>
        
        <div id="upload-preview" class="upload-preview" style="display: none;">
          <h3><i class="fas fa-eye"></i> Upload Preview</h3>
          <div id="preview-info" class="preview-info" style="margin-bottom: 1rem; padding: 0.5rem; background-color: rgba(114, 47, 55, 0.05); border-radius: var(--radius);">
            <p><strong>Total Records:</strong> <span id="total-records">0</span></p>
            <p><strong>Preview Rows:</strong> <span id="preview-rows">0</span></p>
          </div>
          <div id="preview-table-container" style="overflow-x: auto;"></div>
          <div class="actions">
            <button id="confirm-upload" class="btn-success">
              <i class="fas fa-check"></i> Confirm Upload
            </button>
            <button id="cancel-upload" class="btn-secondary">
              <i class="fas fa-times"></i> Cancel
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Search Page -->
    <div id="search" class="page">
      <div class="card">
        <h2><i class="fas fa-search"></i> Search Students</h2>
        
        <div class="search-container">
          <input type="text" id="search-input" class="search-input" placeholder="Enter student name, index number, or any field...">
          <button id="search-btn" class="btn-primary">
            <i class="fas fa-search"></i> Search
          </button>
          <button id="clear-search" class="btn-secondary">
            <i class="fas fa-eraser"></i> Clear
          </button>
        </div>
        
        <div class="filter-container">
          <select id="filter-class" class="filter-select">
            <option value="">All Classes</option>
          </select>
          <select id="filter-year" class="filter-select">
            <option value="">All Years</option>
          </select>
          <select id="filter-program" class="filter-select">
            <option value="">All Programs</option>
          </select>
        </div>
        
        <div id="search-results">
          <div style="overflow-x: auto;">
            <table id="students-table">
              <thead>
                <tr id="students-table-header">
                  <!-- Table headers will be populated dynamically -->
                </tr>
              </thead>
              <tbody id="students-tbody">
                <!-- Students will be populated here -->
              </tbody>
            </table>
          </div>
          <div id="pagination-controls" class="actions" style="justify-content: center;"></div>
        </div>
        
        <div class="actions">
          <button id="export-excel" class="btn-success">
            <i class="fas fa-file-excel"></i> Export to Excel
          </button>
          <button id="export-pdf" class="btn-danger">
            <i class="fas fa-file-pdf"></i> Print to PDF
          </button>
          <button id="clear-data" class="btn-warning">
            <i class="fas fa-trash"></i> Clear All Data
          </button>
        </div>
      </div>
      
      <div id="student-details" class="student-details card">
        <h2><i class="fas fa-user-graduate"></i> Student Details</h2>
        <div id="student-info" class="student-info">
          <!-- Student details will be populated here -->
        </div>
        <div class="actions">
          <button id="print-student" class="btn-primary">
            <i class="fas fa-print"></i> Print Student Details
          </button>
          <button id="back-to-search" class="btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Search
          </button>
        </div>
      </div>
    </div>
  </main>

  <!-- Toast Notification -->
  <div class="toast" id="toast">
    <i class="fas fa-info-circle"></i>
    <span id="toast-message">This is a toast message</span>
  </div>

  <!-- Modal for Confirmations -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <h3 id="modal-title">Confirm Action</h3>
      <p id="modal-message">Are you sure you want to proceed?</p>
      <div class="modal-actions">
        <button id="modal-confirm" class="btn-primary">Yes</button>
        <button id="modal-cancel" class="btn-secondary">Cancel</button>
      </div>
    </div>
  </div>

  <footer>
    <div class="container">
      <p>&copy; 2025 Alkhulafau SHS. All Rights Reserved.</p>
    </div>
  </footer>

  <!-- External Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <script>
    // Application state
    const state = {
      students: [],
      currentStudent: null,
      tableHeaders: [],
      filteredStudents: [],
      currentPage: 1,
      itemsPerPage: 20,
      filters: {
        class: '',
        year: '',
        program: ''
      },
      previewRows: 50 // Increased from 10 to 50
    };

    // DOM elements
    const elements = {
      // Pages
      pages: document.querySelectorAll('.page'),
      navLinks: document.querySelectorAll('.nav-link'),
      
      // Dashboard
      totalStudents: document.getElementById('total-students'),
      currentYear: document.getElementById('current-year'),
      lastUpdated: document.getElementById('last-updated'),
      
      // Upload
      fileUploadArea: document.getElementById('file-upload-area'),
      excelFileInput: document.getElementById('excel-file'),
      uploadPreview: document.getElementById('upload-preview'),
      previewTableContainer: document.getElementById('preview-table-container'),
      totalRecords: document.getElementById('total-records'),
      previewRows: document.getElementById('preview-rows'),
      confirmUpload: document.getElementById('confirm-upload'),
      cancelUpload: document.getElementById('cancel-upload'),
      
      // Search
      searchInput: document.getElementById('search-input'),
      searchBtn: document.getElementById('search-btn'),
      clearSearch: document.getElementById('clear-search'),
      studentsTableHeader: document.getElementById('students-table-header'),
      studentsTbody: document.getElementById('students-tbody'),
      studentDetails: document.getElementById('student-details'),
      studentInfo: document.getElementById('student-info'),
      backToSearch: document.getElementById('back-to-search'),
      printStudent: document.getElementById('print-student'),
      exportExcel: document.getElementById('export-excel'),
      exportPdf: document.getElementById('export-pdf'),
      clearData: document.getElementById('clear-data'),
      paginationControls: document.getElementById('pagination-controls'),
      
      // Filters
      filterClass: document.getElementById('filter-class'),
      filterYear: document.getElementById('filter-year'),
      filterProgram: document.getElementById('filter-program'),
      
      // Toast and Modal
      toast: document.getElementById('toast'),
      toastMessage: document.getElementById('toast-message'),
      modal: document.getElementById('modal'),
      modalTitle: document.getElementById('modal-title'),
      modalMessage: document.getElementById('modal-message'),
      modalConfirm: document.getElementById('modal-confirm'),
      modalCancel: document.getElementById('modal-cancel'),
      
      // Buttons
      backupBtn: document.getElementById('backupBtn'),
      restoreBtn: document.getElementById('restoreBtn'),
      refreshBtn: document.getElementById('refreshBtn'),
      installBtn: document.getElementById('installBtn'),
      themeToggle: document.getElementById('themeToggle')
    };

    // Initialize the application
    function init() {
      loadStudents();
      setupEventListeners();
      updateDashboard();
      updateFilterOptions();
      
      // Set current year
      elements.currentYear.textContent = new Date().getFullYear();
    }

    // Load students from localStorage
    function loadStudents() {
      const stored = localStorage.getItem('alkhulafauStudents');
      const headers = localStorage.getItem('alkhulafauHeaders');
      const lastUpdated = localStorage.getItem('alkhulafauLastUpdated');
      
      if (stored) {
        state.students = JSON.parse(stored);
        state.filteredStudents = [...state.students];
      }
      
      if (headers) {
        state.tableHeaders = JSON.parse(headers);
      }
      
      if (lastUpdated) {
        elements.lastUpdated.textContent = new Date(parseInt(lastUpdated)).toLocaleString();
      }
    }

    // Save students to localStorage
    function saveStudents() {
      localStorage.setItem('alkhulafauStudents', JSON.stringify(state.students));
      localStorage.setItem('alkhulafauHeaders', JSON.stringify(state.tableHeaders));
      localStorage.setItem('alkhulafauLastUpdated', Date.now().toString());
    }

    // Set up event listeners
    function setupEventListeners() {
      // Navigation
      elements.navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const pageId = link.getAttribute('data-page');
          showPage(pageId);
          
          // Update active nav link
          elements.navLinks.forEach(l => l.classList.remove('active'));
          link.classList.add('active');
        });
      });

      // File upload
      elements.fileUploadArea.addEventListener('click', () => {
        elements.excelFileInput.click();
      });
      
      elements.excelFileInput.addEventListener('change', handleFileUpload);
      
      // Upload confirmation
      elements.confirmUpload.addEventListener('click', confirmUpload);
      elements.cancelUpload.addEventListener('click', cancelUpload);

      // Search functionality
      elements.searchBtn.addEventListener('click', handleSearch);
      elements.clearSearch.addEventListener('click', clearSearch);
      elements.searchInput.addEventListener('keyup', (e) => {
        if (e.key === 'Enter') {
          handleSearch();
        }
      });

      // Student details
      elements.backToSearch.addEventListener('click', () => {
        elements.studentDetails.classList.remove('active');
      });
      
      elements.printStudent.addEventListener('click', printStudentDetails);

      // Export functionality
      elements.exportExcel.addEventListener('click', exportToExcel);
      elements.exportPdf.addEventListener('click', exportToPdf);
      
      // Clear data
      elements.clearData.addEventListener('click', () => {
        showModal(
          'Clear All Data',
          'Are you sure you want to clear all student data? This action cannot be undone.',
          clearAllData
        );
      });
      
      // Dashboard buttons
      elements.backupBtn.addEventListener('click', backupData);
      elements.restoreBtn.addEventListener('click', restoreData);
      elements.refreshBtn.addEventListener('click', refreshData);
      
      // Filter changes
      elements.filterClass.addEventListener('change', applyFilters);
      elements.filterYear.addEventListener('change', applyFilters);
      elements.filterProgram.addEventListener('change', applyFilters);
      
      // Modal
      elements.modalCancel.addEventListener('click', hideModal);
      
      // Theme toggle
      elements.themeToggle.addEventListener('click', toggleTheme);
      
      // Install button
      elements.installBtn.addEventListener('click', installApp);
    }

    // Show specific page
    function showPage(pageId) {
      elements.pages.forEach(page => {
        page.classList.remove('active');
      });
      document.getElementById(pageId).classList.add('active');
      
      if (pageId === 'search') {
        displayAllStudents();
      } else if (pageId === 'dashboard') {
        updateDashboard();
      } else if (pageId === 'upload') {
        // Reset upload form
        elements.uploadPreview.style.display = 'none';
        elements.excelFileInput.value = '';
      }
    }

    // Handle Excel file upload
    function handleFileUpload(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          
          // Assuming first sheet
          const worksheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(worksheet);
          
          if (jsonData.length > 0) {
            // Extract headers
            const firstRow = jsonData[0];
            state.tableHeaders = Object.keys(firstRow);
            
            // Show preview with count information
            showUploadPreview(jsonData);
          } else {
            showToast('The uploaded file appears to be empty', 'warning');
          }
        } catch (error) {
          showToast('Error reading file: ' + error.message, 'error');
        }
      };
      reader.onerror = function() {
        showToast('Error reading file', 'error');
      };
      reader.readAsArrayBuffer(file);
    }

    // Show upload preview with count information
    function showUploadPreview(data) {
      if (data.length === 0) return;
      
      // Update preview info
      elements.totalRecords.textContent = data.length;
      elements.previewRows.textContent = Math.min(state.previewRows, data.length);
      
      // Create preview table
      let tableHTML = '<table><thead><tr>';
      
      // Add headers
      state.tableHeaders.forEach(header => {
        tableHTML += `<th>${header}</th>`;
      });
      
      tableHTML += '</tr></thead><tbody>';
      
      // Add data rows - show up to previewRows (50) instead of just 10
      const previewData = data.slice(0, state.previewRows);
      previewData.forEach(row => {
        tableHTML += '<tr>';
        state.tableHeaders.forEach(header => {
          tableHTML += `<td>${row[header] || ''}</td>`;
        });
        tableHTML += '</tr>';
      });
      
      tableHTML += '</tbody></table>';
      
      elements.previewTableContainer.innerHTML = tableHTML;
      elements.uploadPreview.style.display = 'block';
      
      // Store the full data for confirmation
      elements.uploadPreview.dataset.fullData = JSON.stringify(data);
    }

    // Confirm upload and save data
    function confirmUpload() {
      try {
        const fullData = JSON.parse(elements.uploadPreview.dataset.fullData);
        
        // Replace existing data with new upload
        state.students = fullData;
        state.filteredStudents = [...fullData];
        saveStudents();
        
        // Reset upload form
        elements.uploadPreview.style.display = 'none';
        elements.excelFileInput.value = '';
        
        showToast(`Successfully uploaded ${fullData.length} student records`, 'success');
        updateDashboard();
        updateFilterOptions();
        
        // Switch to search page to view data
        showPage('search');
        const searchLink = document.querySelector('[data-page="search"]');
        elements.navLinks.forEach(l => l.classList.remove('active'));
        searchLink.classList.add('active');
      } catch (error) {
        showToast('Error processing upload: ' + error.message, 'error');
      }
    }

    // Cancel upload
    function cancelUpload() {
      elements.uploadPreview.style.display = 'none';
      elements.excelFileInput.value = '';
    }

    // Handle search
    function handleSearch() {
      const query = elements.searchInput.value.trim().toLowerCase();
      
      if (!query) {
        displayAllStudents();
        return;
      }
      
      const results = state.students.filter(student => {
        // Search across all fields
        for (const key in student) {
          if (student[key] && student[key].toString().toLowerCase().includes(query)) {
            return true;
          }
        }
        return false;
      });
      
      state.filteredStudents = results;
      state.currentPage = 1;
      displaySearchResults();
    }

    // Clear search
    function clearSearch() {
      elements.searchInput.value = '';
      state.filteredStudents = [...state.students];
      state.currentPage = 1;
      displaySearchResults();
    }

    // Apply filters
    function applyFilters() {
      state.filters.class = elements.filterClass.value;
      state.filters.year = elements.filterYear.value;
      state.filters.program = elements.filterProgram.value;
      
      let results = [...state.students];
      
      // Apply class filter
      if (state.filters.class) {
        results = results.filter(student => 
          student.Class && student.Class.includes(state.filters.class)
        );
      }
      
      // Apply year filter
      if (state.filters.year) {
        results = results.filter(student => 
          student.Year && student.Year.toString() === state.filters.year
        );
      }
      
      // Apply program filter
      if (state.filters.program) {
        results = results.filter(student => 
          student.Program && student.Program.includes(state.filters.program)
        );
      }
      
      state.filteredStudents = results;
      state.currentPage = 1;
      displaySearchResults();
    }

    // Update filter options based on data
    function updateFilterOptions() {
      // Clear existing options (except the first one)
      elements.filterClass.innerHTML = '<option value="">All Classes</option>';
      elements.filterYear.innerHTML = '<option value="">All Years</option>';
      elements.filterProgram.innerHTML = '<option value="">All Programs</option>';
      
      if (state.students.length === 0) return;
      
      const classes = new Set();
      const years = new Set();
      const programs = new Set();
      
      state.students.forEach(student => {
        if (student.Class) classes.add(student.Class);
        if (student.Year) years.add(student.Year.toString());
        if (student.Program) programs.add(student.Program);
      });
      
      // Add class options
      classes.forEach(cls => {
        const option = document.createElement('option');
        option.value = cls;
        option.textContent = cls;
        elements.filterClass.appendChild(option);
      });
      
      // Add year options
      years.forEach(year => {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        elements.filterYear.appendChild(option);
      });
      
      // Add program options
      programs.forEach(program => {
        const option = document.createElement('option');
        option.value = program;
        option.textContent = program;
        elements.filterProgram.appendChild(option);
      });
    }

    // Display all students in table
    function displayAllStudents() {
      state.filteredStudents = [...state.students];
      state.currentPage = 1;
      displaySearchResults();
    }

    // Display search results in table
    function displaySearchResults() {
      // Clear previous results
      elements.studentsTbody.innerHTML = '';
      elements.studentsTableHeader.innerHTML = '';
      
      if (state.filteredStudents.length === 0) {
        elements.studentsTbody.innerHTML = '<tr><td colspan="' + (state.tableHeaders.length + 1) + '" style="text-align: center;">No students found</td></tr>';
        elements.paginationControls.innerHTML = '';
        return;
      }
      
      // Create table headers
      state.tableHeaders.forEach(header => {
        const th = document.createElement('th');
        th.textContent = header;
        elements.studentsTableHeader.appendChild(th);
      });
      
      // Add actions header
      const actionsTh = document.createElement('th');
      actionsTh.textContent = 'Actions';
      elements.studentsTableHeader.appendChild(actionsTh);
      
      // Calculate pagination
      const totalPages = Math.ceil(state.filteredStudents.length / state.itemsPerPage);
      const startIndex = (state.currentPage - 1) * state.itemsPerPage;
      const endIndex = Math.min(startIndex + state.itemsPerPage, state.filteredStudents.length);
      const pageStudents = state.filteredStudents.slice(startIndex, endIndex);
      
      // Create table rows
      pageStudents.forEach((student, index) => {
        const row = document.createElement('tr');
        
        // Add data cells
        state.tableHeaders.forEach(header => {
          const td = document.createElement('td');
          td.textContent = student[header] || 'N/A';
          row.appendChild(td);
        });
        
        // Add actions cell
        const actionsTd = document.createElement('td');
        const viewButton = document.createElement('button');
        viewButton.textContent = 'View';
        viewButton.className = 'btn-primary';
        viewButton.style.padding = '0.3rem 0.6rem';
        viewButton.dataset.index = startIndex + index;
        actionsTd.appendChild(viewButton);
        row.appendChild(actionsTd);
        
        elements.studentsTbody.appendChild(row);
      });
      
      // Add event listeners to view buttons
      document.querySelectorAll('.btn-primary[data-index]').forEach(button => {
        button.addEventListener('click', (e) => {
          const studentIndex = parseInt(e.target.getAttribute('data-index'));
          viewStudentDetails(studentIndex);
        });
      });
      
      // Create pagination controls
      createPaginationControls(totalPages);
    }

    // Create pagination controls
    function createPaginationControls(totalPages) {
      if (totalPages <= 1) {
        elements.paginationControls.innerHTML = '';
        return;
      }
      
      let paginationHTML = '';
      
      // Previous button
      if (state.currentPage > 1) {
        paginationHTML += `<button class="btn-secondary" id="prev-page"><i class="fas fa-chevron-left"></i> Previous</button>`;
      }
      
      // Page numbers
      for (let i = 1; i <= totalPages; i++) {
        if (i === state.currentPage) {
          paginationHTML += `<button class="btn-primary">${i}</button>`;
        } else if (
          i === 1 || 
          i === totalPages || 
          (i >= state.currentPage - 1 && i <= state.currentPage + 1)
        ) {
          paginationHTML += `<button class="btn-secondary page-number" data-page="${i}">${i}</button>`;
        } else if (i === state.currentPage - 2 || i === state.currentPage + 2) {
          paginationHTML += `<span>...</span>`;
        }
      }
      
      // Next button
      if (state.currentPage < totalPages) {
        paginationHTML += `<button class="btn-secondary" id="next-page">Next <i class="fas fa-chevron-right"></i></button>`;
      }
      
      elements.paginationControls.innerHTML = paginationHTML;
      
      // Add event listeners
      document.querySelectorAll('.page-number').forEach(button => {
        button.addEventListener('click', (e) => {
          state.currentPage = parseInt(e.target.getAttribute('data-page'));
          displaySearchResults();
        });
      });
      
      const prevButton = document.getElementById('prev-page');
      if (prevButton) {
        prevButton.addEventListener('click', () => {
          state.currentPage--;
          displaySearchResults();
        });
      }
      
      const nextButton = document.getElementById('next-page');
      if (nextButton) {
        nextButton.addEventListener('click', () => {
          state.currentPage++;
          displaySearchResults();
        });
      }
    }

    // View student details
    function viewStudentDetails(studentIndex) {
      const student = state.filteredStudents[studentIndex];
      
      if (!student) {
        showToast('Student not found', 'error');
        return;
      }
      
      state.currentStudent = student;
      
      // Populate student details
      elements.studentInfo.innerHTML = '';
      
      state.tableHeaders.forEach(header => {
        const infoItem = document.createElement('div');
        infoItem.className = 'info-item';
        
        const infoLabel = document.createElement('div');
        infoLabel.className = 'info-label';
        infoLabel.textContent = header;
        
        const infoValue = document.createElement('div');
        infoValue.textContent = student[header] || 'N/A';
        
        infoItem.appendChild(infoLabel);
        infoItem.appendChild(infoValue);
        
        elements.studentInfo.appendChild(infoItem);
      });
      
      elements.studentDetails.classList.add('active');
    }

    // Print student details
    function printStudentDetails() {
      if (!state.currentStudent) return;
      
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Add title
      doc.setFontSize(18);
      doc.text('Alkhulafau SHS - Student Details', 20, 20);
      
      // Add student information
      doc.setFontSize(12);
      let yPosition = 40;
      
      const student = state.currentStudent;
      
      state.tableHeaders.forEach(header => {
        if (student[header]) {
          doc.text(`${header}: ${student[header]}`, 20, yPosition);
          yPosition += 10;
          
          // Add new page if needed
          if (yPosition > 270) {
            doc.addPage();
            yPosition = 20;
          }
        }
      });
      
      // Save the PDF
      doc.save(`student_${student.indexNumber || 'details'}.pdf`);
      showToast('Student details exported to PDF', 'success');
    }

    // Export to Excel
    function exportToExcel() {
      if (state.students.length === 0) {
        showToast('No students to export', 'warning');
        return;
      }
      
      const worksheet = XLSX.utils.json_to_sheet(state.students);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, 'Students');
      
      // Generate and download the file
      XLSX.writeFile(workbook, 'alkhulafau_students.xlsx');
      showToast('Students exported to Excel successfully', 'success');
    }

    // Export to PDF
    function exportToPdf() {
      if (state.students.length === 0) {
        showToast('No students to export', 'warning');
        return;
      }
      
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Add title
      doc.setFontSize(18);
      doc.text('Alkhulafau SHS - Student List', 20, 20);
      
      // Create table
      const tableColumn = state.tableHeaders;
      const tableRows = [];
      
      state.students.forEach(student => {
        const rowData = [];
        state.tableHeaders.forEach(header => {
          rowData.push(student[header] || 'N/A');
        });
        tableRows.push(rowData);
      });
      
      doc.autoTable({
        head: [tableColumn],
        body: tableRows,
        startY: 30,
        styles: { fontSize: 8 },
        headStyles: { fillColor: [114, 47, 55] } // Wine color
      });
      
      // Save the PDF
      doc.save('alkhulafau_students.pdf');
      showToast('Students exported to PDF successfully', 'success');
    }

    // Clear all data
    function clearAllData() {
      state.students = [];
      state.filteredStudents = [];
      state.tableHeaders = [];
      localStorage.removeItem('alkhulafauStudents');
      localStorage.removeItem('alkhulafauHeaders');
      localStorage.removeItem('alkhulafauLastUpdated');
      
      showToast('All student data has been cleared', 'success');
      updateDashboard();
      updateFilterOptions();
      displayAllStudents();
      hideModal();
    }

    // Backup data
    function backupData() {
      const data = {
        students: JSON.parse(localStorage.getItem('alkhulafauStudents') || '[]'),
        headers: JSON.parse(localStorage.getItem('alkhulafauHeaders') || '[]'),
      };
      const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'alkhulafau_backup.json';
      a.click();
      showToast('Backup downloaded successfully', 'success');
    }

    // Restore data
    function restoreData() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const data = JSON.parse(event.target.result);
            localStorage.setItem('alkhulafauStudents', JSON.stringify(data.students));
            localStorage.setItem('alkhulafauHeaders', JSON.stringify(data.headers));
            localStorage.setItem('alkhulafauLastUpdated', Date.now().toString());
            
            // Reload data
            loadStudents();
            updateDashboard();
            updateFilterOptions();
            
            showToast('Backup restored successfully!', 'success');
          } catch {
            showToast('Invalid backup file!', 'error');
          }
        };
        reader.readAsText(file);
      };
      input.click();
    }

    // Refresh data
    function refreshData() {
      loadStudents();
      updateDashboard();
      updateFilterOptions();
      showToast('Data refreshed successfully', 'success');
    }

    // Update dashboard
    function updateDashboard() {
      elements.totalStudents.textContent = state.students.length;
      elements.lastUpdated.textContent = state.students.length > 0 ? 
        new Date(parseInt(localStorage.getItem('alkhulafauLastUpdated'))).toLocaleString() : 'Never';
      
      // Update chart if it exists
      updateChart();
    }

    // Update chart
    function updateChart() {
      const ctx = document.getElementById('chartStudents');
      if (!ctx) return;
      
      // Sample data - in a real app, you would aggregate data from students
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['2021', '2022', '2023', '2024'],
          datasets: [{
            label: 'Total Students',
            data: [120, 140, 160, state.students.length || 180],
            backgroundColor: '#722f37'
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
            },
            title: {
              display: true,
              text: 'Student Enrollment by Year'
            }
          }
        }
      });
    }

    // Show toast notification
    function showToast(message, type = 'info') {
      elements.toastMessage.textContent = message;
      elements.toast.className = 'toast ' + type;
      elements.toast.classList.add('show');
      
      setTimeout(() => {
        elements.toast.classList.remove('show');
      }, 3000);
    }

    // Show modal
    function showModal(title, message, confirmCallback) {
      elements.modalTitle.textContent = title;
      elements.modalMessage.textContent = message;
      elements.modal.classList.add('active');
      
      // Set up confirm button
      elements.modalConfirm.onclick = () => {
        confirmCallback();
      };
    }

    // Hide modal
    function hideModal() {
      elements.modal.classList.remove('active');
    }

    // Theme toggle
    function toggleTheme() {
      const isDark = document.body.classList.toggle('dark');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      elements.themeToggle.innerHTML = isDark ? 
        '<i class="fas fa-sun"></i>' : 
        '<i class="fas fa-moon"></i>';
    }

    // Install app (PWA)
    function installApp() {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
          if (choiceResult.outcome === 'accepted') {
            showToast('App installed successfully!', 'success');
          }
          deferredPrompt = null;
        });
      }
    }

    // PWA Install Prompt
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      elements.installBtn.style.display = 'inline-flex';
    });

    // Initialize theme
    const currentTheme = localStorage.getItem('theme') || 'light';
    document.body.classList.toggle('dark', currentTheme === 'dark');
    elements.themeToggle.innerHTML = currentTheme === 'dark' ? 
      '<i class="fas fa-sun"></i>' : 
      '<i class="fas fa-moon"></i>';

    // Initialize the app when DOM is loaded
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
